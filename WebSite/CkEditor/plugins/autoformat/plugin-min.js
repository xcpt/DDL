CKEDITOR.plugins.add("autoformat",{init:function(a){a.addCommand("autoformat",{exec:function(b){FormatText(b)},canUndo:false});a.ui.addButton("autoformat",{label:"\u81ea\u52a8\u6392\u7248\u3010\u4f1a\u6e05\u9664\u4e00\u4e9b\u6837\u5f0f\u683c\u5f0f\uff0c\u5305\u542b\u94fe\u63a5\u3011",command:"autoformat",icon:this.path+"images/autoformat.gif"})}});if(!document.all){HTMLElement.prototype.__defineGetter__("innerText",function(){var b="";var c=this.childNodes;for(var a=0;a<c.length;a++){if(c[a].nodeType==1){b+=c[a].tagName=="BR"?"\n":c[a].innerText}else{if(c[a].nodeType==3){b+=c[a].nodeValue}}}return b});HTMLElement.prototype.__defineSetter__("innerText",function(a){this.textContent=a})}function FormatText(k){var o=k;if(o.mode=="wysiwyg"){var B=new Array();var C=new Array();var x=new Array();var y=false;if(!y){var b=document.createElement("DIV");var m=o.getData();m=m.replace(/<div style="page-break-after: always;?">\s*<span style="display: none;?">&nbsp;<\/span>\s*<\/div>/gi,"<p>[page]</p>");b.innerHTML=m.replace(/&nbsp;/gi,"").replace(/<div/gi,"<p").replace(/<\/div/gi,"</p");if(window.navigator.userAgent.toLowerCase().indexOf("msie")>0){b.innerHTML=b.innerHTML.replace(/<\/p>/gi,"<br /></p>")}var p=b.getElementsByTagName("TABLE");if(p!=null&&p.length>0){for(var z=0;z<p.length;z++){C[C.length]=p[z].outerHTML}var g=0;for(var z=0;z<p.length;){p[z].outerHTML="#FormatTableID_"+g+"#";g++}}var c=b.getElementsByTagName("OBJECT");if(c!=null&&c.length>0){for(var z=0;z<c.length;z++){x[x.length]=c[z].outerHTML}var s=0;for(var z=0;z<c.length;){c[z].outerHTML="#FormatObjectID_"+s+"#";s++}}var v=b.getElementsByTagName("IMG");if(v!=null&&v.length>0){for(var z=0;z<v.length;z++){var u=document.createElement("IMG");u.alt=v[z].alt;u.src=v[z].src;u.width=v[z].width;u.height=v[z].height;u.align=v[z].align;B[B.length]=u}var E=0;for(var z=0;z<v.length;){v[z].outerHTML="#FormatImgID_"+E+"#";E++}}var d=new Array();var a=0;var D=b.getElementsByTagName("b");if(D!=null&&D.length>0){for(var A=0;A<D.length;A++){d[a]=D[A].innerText.Trim();D[A].innerHTML="#FormatStrongID_"+a+"#";a++}}var f=b.getElementsByTagName("strong");if(f!=null&&f.length>0){for(var A=0;A<f.length;A++){d[a]=f[A].innerText.Trim();f[A].innerHTML="#FormatStrongID_"+a+"#";a++}}var r=processFormatText(b.innerText);r=r.replace(/<p style="text-indent: 2em;">\[page\]<\/p>/gi,'<div style="page-break-after: always;"><span style="display: none;">&nbsp;</span></div>');if(C!=null&&C.length>0){for(var z=0;z<C.length;z++){var q=C[z];r=r.replace("#FormatTableID_"+z+"#",q)}}if(x!=null&&x.length>0){for(var z=0;z<x.length;z++){var w='<p align="center">'+x[z]+"</p>";r=r.replace("#FormatObjectID_"+z+"#",w)}}if(B!=null&&B.length>0){for(var z=0;z<B.length;z++){var n="";var h="";if(B[z].height!=0){imaheight=' height="'+B[z].height+'"'}if(B[z].width!=0){h=' width="'+B[z].width+'"'}var l="";if(B[z].align!=""){l=' align="'+B[z].align+'"'}var e='<p align="center"><img src="'+B[z].src+'" alt="'+B[z].alt+'"'+h+" "+n+' align="'+B[z].align+'" border="0"></p>';r=r.replace("#FormatImgID_"+z+"#",e)}}for(var A=0;A<a;A++){r=r.replace("#FormatStrongID_"+A+"#","<p><strong>"+d[A]+"</strong></p>")}while(r.indexOf("</p></p>")!=-1){r=r.replace("</p></p>","</p>")}while(r.indexOf('<p><p align="center">')!=-1){r=r.replace('<p><p align="center">','<p align="center">')}o.setData(r)}}}function processFormatText(a){var k=DBC2SBC(a);var h="";var e=k.split("\n");var g="";for(var c=0;c<e.length;c++){var d=e[c].Trim();if(d.length>0){var b=/#Format[A-Za-z]+_\d+#/gi;var j=b.exec(d);if(j!=null){d=d.replace(/#Format[A-Za-z]+_\d+#/gi,"");g+=j;if(d!=""){g+='<p align="center">'+d+"</p>\n"}}else{g+='<p style="text-indent: 2em;">'+d+"</p>\n"}}}return g}function DBC2SBC(d){var a="";for(var b=0;b<d.length;b++){var c=d.charCodeAt(b);if(c>=65281&&c<65373&&c!=65292&&c!=65306){a+=String.fromCharCode(d.charCodeAt(b)-65248)}else{a+=d.charAt(b)}}return a};
